{"version":3,"names":[],"mappings":"","sources":["consulting/controllers/consulting-7-1-post-controller.js"],"sourcesContent":["(function () {\n  'use strict';\n\n  angular.module('consulting')\n    .controller('ConsultingPostCtrl', Ctrl);\n\n  Ctrl.$inject = ['dialogs', 'vcRecaptchaService',\n                  'APP_CONFIG', 'InApiUtils', 'InApiValidator', 'ValidationSummary', 'ConsultingQuest'];\n\n  function Ctrl(dialogs, vcRecaptchaService,\n                APP_CONFIG, InApiUtils, InApiValidator, ValidationSummary, ConsultingQuest) {\n    var vm = this, reCaptchaWidgetId = '', isRecaptchaValid = false;\n\n    vm.isSending = false;\n    vm.siteKey = APP_CONFIG.reCaptchaSiteKey;\n\n    function validateForm() {\n      var summary = ValidationSummary, email = vm.email || '', questType = vm.questType || '', descp = vm.descp || '';\n\n      summary.clear();\n\n      if (!email || email.length < 1) {\n        summary.push('聯絡信箱不得為空');\n      } else if (!InApiValidator.isValidEmail(email)) {\n        summary.push('請輸入正確的聯絡信箱格式，例如：abc@tttmail.xyz');\n      } else if (email.length > 64) {\n        summary.push('聯絡信箱長度不得超過 64 個字元');\n      }\n\n      if (!questType || questType.length < 1) {\n        summary.push('請選擇問題類型');\n      }\n\n      if (!descp || descp.length < 1) {\n        summary.push('問題描述不得為空');\n      }\n\n      if (!isRecaptchaValid) {\n        summary.push('請確實勾選\"我不是機器人\"核選方塊');\n      }\n\n      if (summary.count() > 0) {\n        dialogs.notify('表單驗證有誤', summary.flush());\n        return false;\n      }\n\n      return true;\n    }\n\n    function resetForm() {\n      vm.email = vm.questType = vm.descp = vm.snippet = '';\n    }\n\n    function handleErrCode(err) {\n      err = err || {code: ''};\n\n      switch (err.code) {\n        case '0':\n          dialogs.notify('問題送出成功', '您的諮詢信件已寄出，我們將儘快回覆您的問題至所指定信箱。');\n          resetForm();\n          break;\n        case '7100':\n          dialogs.notify('問題送出失敗', '驗證失敗，表單參數有誤，請確認後再行送出。');\n          break;\n        case 'r9001':\n          dialogs.notify('問題送出失敗', '請確實勾選 \"我不是機器人\" 核選方塊');\n          break;\n        case 'r9002':\n          dialogs.notify('問題送出失敗', '身份驗證不合法。');\n          break;\n        case 'r9100':\n          dialogs.notify('問題送出失敗', '寄送信件發生錯誤，請稍後再試。');\n          break;\n        default:\n          dialogs.notify(\n            '問題送出失敗',\n            InApiUtils.stringFormat('發生未知錯誤，錯誤代碼：{0}, 錯誤訊息：{1}', err.code, err.msg)\n          );\n          break;\n      }\n    }\n\n    function doSumbit() {\n      var postParams;\n\n      if (validateForm()) {\n        vm.isSending = true;\n        /* jshint camelcase:false */\n        /* eslint camelcase:0 */\n        postParams = {\n          email: (vm.email || '').toLowerCase(),\n          questType: vm.questType || '',\n          descp: vm.descp || '',\n          snippet: vm.snippet || '',\n          'g-recaptcha-response': vm.gResponse || ''\n        };\n\n        ConsultingQuest.doPost(postParams)\n          .then(function (resData) {\n            handleErrCode(resData.err);\n          }, function (resData) {\n            if (resData && resData.err && resData.err.code === 'r8999') {\n              dialogs.notify('身份驗證失敗', '安全金鑰已過期，請重新登入');\n            } else {\n              dialogs.notify('問題送出失敗', '伺服器發生問題，請稍後再試。');\n            }\n          }).finally(function () {\n            vm.isSending = false;\n            resetRecaptcha();\n          });\n      }\n\n      return false;\n    }\n\n    function setWidgetId(widgetId) {\n      reCaptchaWidgetId = widgetId;\n    }\n\n    function setRecaptchaIsChecked() {\n      isRecaptchaValid = true;\n    }\n\n    function resetRecaptcha() {\n      isRecaptchaValid = false;\n      vcRecaptchaService.reload(reCaptchaWidgetId);\n    }\n\n    vm.doSumbit = doSumbit;\n    vm.setWidgetId = setWidgetId;\n    vm.setRecaptchaIsChecked = setRecaptchaIsChecked;\n    vm.resetRecaptcha = resetRecaptcha;\n\n    return vm;\n  }\n}());\n"],"file":"consulting-7-1-post-controller.js"}