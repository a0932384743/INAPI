{"version":3,"names":[],"mappings":"","sources":["devicelog/constrollers/devicelog-5-3-detail-controller.js"],"sourcesContent":["(function () {\n  'use strict';\n\n  angular.module('devicelog')\n    .controller('DevicelogDetailCtrl', Ctrl);\n\n  Ctrl.$inject = ['$scope', '$state', '$stateParams', 'dialogs', 'moment', 'ValidationSummary', 'TableauDAO'];\n\n  function Ctrl($scope, $state, $stateParams, dialogs, moment, ValidationSummary, TableauDAO) {\n    var vm = this, devId, devCategory, measureValue;\n\n    if (!validateParams($stateParams)) {\n      dialogs.notify('查詢失敗', '帶入裝置 ID 或裝置類別錯誤');\n      $state.go('devicelog.list');\n      return vm;\n    }\n\n    devId = $stateParams.devId;\n    devCategory = $stateParams.devCategory;\n\n    vm.devId = devId;\n    vm.devCategory = devCategory;\n    vm.tableauFilters = {};\n    vm.measureOptions = TableauDAO.getMeasureOptions(devCategory);\n    vm.timeFilterS = moment().startOf('hour');\n    vm.timeFilterE = moment().startOf('hour').add(1, 'hour');\n\n    function validateParams(stateParams) {\n      var categories = ['OUTLET', 'SENSOR'];\n\n      if (!stateParams || !stateParams.devId || !stateParams.devCategory || categories.indexOf(stateParams.devCategory) < 0) {\n        return false;\n      }\n\n      return true;\n    }\n\n    function validateForm() {\n      var summary = ValidationSummary;\n\n      summary.clear();\n\n      if (!vm.measureParam) {\n        summary.push('請選擇量測參數');\n      }\n\n      if (!vm.timeFilterS || vm.timeFilterS === true) {\n        summary.push('請選擇起始時間');\n      }\n\n      if (!vm.timeFilterE || vm.timeFilterE === true) {\n        summary.push('請選擇結束時間');\n      }\n\n      if (summary.count() > 0) {\n        dialogs.notify('表單驗證有誤', summary.flush());\n        return false;\n      }\n\n      return true;\n    }\n\n    function applyFiltersToTableau() {\n      var reportTimeMin = vm.timeFilterS.format('YYYY-MM-DD HH:mm:ss'),\n          reportTimeMax = vm.timeFilterE.format('YYYY-MM-DD HH:mm:ss');\n\n      measureValue = vm.measureParam.value;\n\n      if (devCategory === 'OUTLET') {\n        vm.tableauFilters = {\n          olid: devId,\n          reporttime: {\n            min: reportTimeMin,\n            max: reportTimeMax\n          }\n        };\n      } else {\n        vm.tableauFilters = {\n          deviceid: devId,\n          attrid: measureValue,\n          reporttime: {\n            min: reportTimeMin,\n            max: reportTimeMax\n          }\n        };\n      }\n    }\n\n    function goList() {\n      $state.go('devicelog.list');\n    }\n\n    function doQuery() {\n      if (validateForm()) {\n        vm.qryMeasureLabel = vm.measureParam.label;\n        vm.qryTimeFilterSLabel = vm.timeFilterS.format('YYYY-MM-DD HH:mm');\n        vm.qryTimeFilterELabel = vm.timeFilterE.format('YYYY-MM-DD HH:mm');\n\n        if (measureValue !== vm.measureParam.value) {\n          TableauDAO.getTableauQueryUrl(devCategory, vm.measureParam)\n            .then(function (url) {\n              vm.tableauUrl = url;\n              applyFiltersToTableau();\n            });\n        } else {\n          applyFiltersToTableau();\n        }\n      }\n    }\n\n    function adjustStartTimeMinMax() {\n      vm.timeFilterSMax = moment().startOf('hour');\n    }\n\n    function adjustEndTimeMinMax() {\n      var now, maxTime;\n\n      now = moment().startOf('hour').add(1, 'hour');\n      maxTime = moment.isMoment(vm.timeFilterS) ? vm.timeFilterS.clone().startOf('hour').add(14, 'day') : now;\n\n      vm.timeFilterEMin = moment.isMoment(vm.timeFilterS) ? vm.timeFilterS.clone().startOf('hour').add(1, 'hour') : null;\n      vm.timeFilterEMax = now.diff(maxTime, 'hour') > 0 ? maxTime : now;\n    }\n\n    $scope.$watch('vm.timeFilterS._d', function () {\n      adjustEndTimeMinMax();\n      vm.timeFilterE = moment.isMoment(vm.timeFilterS) ? vm.timeFilterS.clone().startOf('hour').add(1, 'hour') : null;\n    }, true);\n\n    vm.goList = goList;\n    vm.doQuery = doQuery;\n    vm.adjustStartTimeMinMax = adjustStartTimeMinMax;\n    vm.adjustEndTimeMinMax = adjustEndTimeMinMax;\n\n    return vm;\n  }\n}());\n"],"file":"devicelog-5-3-detail-controller.js"}