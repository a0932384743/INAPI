{"version":3,"names":[],"mappings":"","sources":["secure/controllers/secure-1-7-email-change-controller.js"],"sourcesContent":["(function () {\n  'use strict';\n\n  angular.module('secure')\n    .controller('SecureEmailChangeCtrl', Ctrl);\n\n  Ctrl.$inject = ['$state', '$translate', 'dialogs',\n                  'APP_CONFIG', 'StorageAPI', 'InApiUtils', 'InApiValidator', 'ValidationSummary', 'SecureAuth'];\n\n  function Ctrl($state, $translate, dialogs,\n                APP_CONFIG, StorageAPI, InApiUtils, InApiValidator, ValidationSummary, SecureAuth) {\n    var vm = this, userId = StorageAPI.getMyUserId() || '';\n\n    vm.isSending = false;\n\n    function authCheck() {\n      if (!userId) {\n        gotoLogin();\n      }\n    }\n\n    function gotoLogin() {\n      $state.go(APP_CONFIG.loginState);\n    }\n\n    function validateForm() {\n      var newEmail = vm.newEmail || '', pwd = vm.pwd || '', summary = ValidationSummary;\n\n      summary.clear();\n\n      if (!newEmail || newEmail.length < 1) {\n        summary.push('電子信箱不得為空');\n      } else if (!InApiValidator.isValidEmail(newEmail)) {\n        summary.push('電子信箱需符合 xxx@xxxx.xxx 格式');\n      } else if (newEmail.length > 64) {\n        summary.push('電子信箱長度不得超過 64 個字元');\n      }\n\n      if (!pwd || pwd.length < 1) {\n        summary.push('密碼不得為空');\n      }\n\n      if (summary.count() > 0) {\n        dialogs.notify('表單驗證有誤', summary.flush());\n        return false;\n      }\n\n      return true;\n    }\n\n    function handleErrCode(err) {\n      err = err || {code: ''};\n\n      switch (err.code) {\n        case '0':\n          dialogs.notify('更換註冊信箱成功', '已將認證信件寄至您的信箱<br />請於認證後再進行登入');\n          gotoLogin();\n          break;\n        case '7000':\n          dialogs.notify('更換註冊信箱失敗', '伺服器發生錯誤，請稍後再次提交表單。');\n          break;\n        case '7100':\n          dialogs.notify('更換註冊信箱失敗', '提交資訊有誤。');\n          vm.newEmail = vm.pwd = '';\n          break;\n        case '7123':\n          dialogs.notify('更換註冊信箱失敗', '密碼錯誤。');\n          vm.pwd = '';\n          break;\n        default:\n          dialogs.notify(\n            '更換註冊信箱失敗',\n            InApiUtils.stringFormat('發生未知錯誤，錯誤代碼：{0}, 錯誤訊息：{1}', err.code, err.msg)\n          );\n      }\n    }\n\n    function doSubmit() {\n      var newEmail, pwd, backUrl, postParams;\n\n      if (validateForm()) {\n        newEmail = (vm.newEmail || '').toLowerCase();\n        pwd = vm.pwd || '';\n        backUrl = SecureAuth.getUserVerifyBackUrl(userId);\n        /* jshint camelcase:false */\n        /* eslint camelcase:0 */\n        postParams = {\n          this_user_id: userId,\n          this_apsystem: 'DPA',\n          pwd: pwd,\n          new_email: newEmail,\n          mail_subject: $translate.instant('CHANGE_MAIL_SUBJECT'),\n          mail_content: InApiUtils.stringFormat($translate.instant('CHANGE_MAIL_CONTENT'), backUrl)\n        };\n\n        vm.isSending = true;\n\n        SecureAuth.doChangeEmail(postParams)\n          .then(function (resData) {\n            handleErrCode(resData.err);\n          }, function () {\n            dialogs.notify('更換註冊信箱失敗', '伺服器拒絕存取，請稍後再試。');\n          }).finally(function () {\n            vm.isSending = false;\n          });\n      }\n\n      return false;\n    }\n\n    authCheck();\n\n    vm.doSubmit = doSubmit;\n\n    return vm;\n  }\n}());\n"],"file":"secure-1-7-email-change-controller.js"}