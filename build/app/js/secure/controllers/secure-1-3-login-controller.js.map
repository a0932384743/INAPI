{"version":3,"names":[],"mappings":"","sources":["secure/controllers/secure-1-3-login-controller.js"],"sourcesContent":["(function () {\n  'use strict';\n\n  angular.module('secure')\n    .controller('SecureLoginCtrl', Ctrl);\n\n  Ctrl.$inject = ['$state', 'dialogs', 'base64', 'APP_CONFIG', 'StorageAPI', 'ValidationSummary', 'SecureAuth'];\n\n  function Ctrl($state, dialogs, base64, APP_CONFIG, StorageAPI, ValidationSummary, SecureAuth) {\n    var vm = this;\n\n    function init() {\n      vm.isSending = false;\n      vm.un = base64.decode(StorageAPI.read('un') || '');\n\n      if (vm.un) {\n        vm.flagRememberMe = true;\n      }\n    }\n\n    function resetForm() {\n      if (!vm.flagRememberMe) {\n        vm.un = '';\n      }\n      vm.pwd = '';\n    }\n\n    function validateForm() {\n      var un = vm.un || '', pwd = vm.pwd || '', summary = ValidationSummary;\n\n      summary.clear();\n\n      if (!un || un.length < 1) {\n        summary.push('帳號不得為空');\n      }\n\n      if (!pwd || pwd.length < 1) {\n        summary.push('密碼不得為空');\n      }\n\n      if (summary.count() > 0) {\n        dialogs.notify('表單驗證有誤', summary.flush());\n        return false;\n      }\n\n      return true;\n    }\n\n    function doSubmit() {\n      var un, pwd;\n\n      if (!validateForm()) {\n        return false;\n      }\n\n      un = vm.un || '';\n      pwd = vm.pwd || '';\n\n      if (vm.flagRememberMe) {\n        StorageAPI.write('un', base64.encode(un));\n      } else {\n        StorageAPI.write('un', null);\n      }\n\n      vm.isSending = true;\n\n      SecureAuth.doLogin(un, pwd)\n        .then(function (data) {\n          var returnState = '';\n          if (data && data.err && data.err.code === 'auth.success.0001') {\n            returnState = StorageAPI.getReturnState();\n\n            if (returnState) {\n              $state.go(returnState);\n              StorageAPI.setReturnState(null);\n            } else {\n              $state.go(APP_CONFIG.firstStateAfterLogin);\n            }\n          }\n        }, function (data) {\n          if (data && data.err && data.err.code === 'auth.failure.0002') {\n            $state.go('secure.register-disabled');\n          } else {\n            dialogs.notify('登入失敗', '<p>帳號或密碼錯誤，</p><p>請確認後再次提交。</p>');\n            resetForm();\n          }\n        }).finally(function () {\n          vm.isSending = false;\n        });\n\n      return false;\n    }\n\n    init();\n\n    vm.doSubmit = doSubmit;\n\n    return vm;\n  }\n}());\n"],"file":"secure-1-3-login-controller.js"}