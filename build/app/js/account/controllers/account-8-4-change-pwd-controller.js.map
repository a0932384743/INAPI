{"version":3,"names":[],"mappings":"","sources":["account/controllers/account-8-4-change-pwd-controller.js"],"sourcesContent":["(function () {\n  'use strict';\n\n  angular.module('account')\n    .controller('ChangePwdCtrl', Ctrl);\n\n  Ctrl.$inject = ['$state', 'dialogs', '$modalInstance',\n                  'InApiUtils', 'InApiValidator', 'ValidationSummary', 'AccountDAO', 'data'];\n\n  function Ctrl($state, dialogs, $modalInstance,\n                InApiUtils, InApiValidator, ValidationSummary, AccountDAO, data) {\n    var vm = this;\n\n    vm.isSending = false;\n    vm.userEmail = data.userEmail;\n\n    function validateForm() {\n      var pwd = vm.pwd || '', newPwd = vm.newPwd || '', newPwdConfirm = vm.newPwdConfirm || '',\n          summary = ValidationSummary;\n\n      summary.clear();\n\n      if (!pwd || pwd.length < 1) {\n        summary.push('舊密碼不得為空');\n      }\n\n      if (!newPwd || newPwd.length < 1) {\n        summary.push('新密碼不得為空');\n      } else if (!InApiValidator.isValidPassword(newPwd)) {\n        summary.push('新密碼須英數字混和');\n      } else if (newPwd.length < 8 || newPwd.length > 12) {\n        summary.push('新密碼長度須介於 8 ~ 12');\n      }\n\n      if (!newPwdConfirm || newPwdConfirm.length < 1) {\n        summary.push('確認密碼不得為空');\n      } else if (newPwdConfirm !== newPwd) {\n        summary.push('新密碼與確認密碼必須一致');\n      }\n\n      if (summary.count() > 0) {\n        dialogs.notify('表單驗證錯誤', summary.flush());\n        return false;\n      }\n\n      return true;\n    }\n\n    function handleErrCode(err) {\n      err = err || {code: ''};\n\n      switch (err.code) {\n        case '0':\n          dialogs.notify('修改密碼成功', '請使用新密碼登入');\n          $state.go('secure.logout');\n          break;\n        case '7000':\n          dialogs.notify('修改密碼失敗', '系統發生錯誤，請稍後再試。');\n          break;\n        case '7100':\n          dialogs.notify('修改密碼失敗', '表單參數有誤，請確認後再行送出。');\n          break;\n        case '7104':\n          dialogs.notify('修改密碼失敗', '舊密碼錯誤，請輸入正確密碼。');\n          break;\n        default:\n          dialogs.notify(\n            '修改密碼失敗',\n            InApiUtils.stringFormat('發生未知錯誤，錯誤代碼：{0}<br/>錯誤訊息：{1}', err.code, err.msg)\n          );\n          break;\n      }\n    }\n\n    function cancel() {\n      $modalInstance.dismiss('close');\n    }\n\n    function doSubmit(thisForm) {\n      if (validateForm(thisForm)) {\n        vm.isSending = true;\n\n        AccountDAO.doChangeUserPwd(vm.pwd, vm.newPwd)\n          .then(function (resData) {\n            cancel();\n            handleErrCode(resData.err);\n          }, function () {\n            cancel();\n            dialogs.notify('修改密碼失敗', '系統發生錯誤，請稍後再試');\n          }).finally(function () {\n            vm.isSending = false;\n          });\n      }\n\n      return false;\n    }\n\n    vm.cancel = cancel;\n    vm.doSubmit = doSubmit;\n\n    return vm;\n  }\n}());\n"],"file":"account-8-4-change-pwd-controller.js"}